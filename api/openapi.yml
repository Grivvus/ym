openapi: 3.0.3
info:
  title: ym music service
  version: "0.1.0"

components:
  schemas:
    UserAuth:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string
          format: password

    UserReturn:
      type: object
      required:
        - username
        - email
        - id
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          nullable: true

    UserChangePassword:
      type: object
      required:
        - old_password
        - new_password
      properties:
        old_password:
          type: string
        new_password:
          type: string

    UserUpdate:
      type: object
      required:
        - new_username
        - new_email
      properties:
        new_username:
          type: string
        new_email:
          type: string

    TokenResponse:
      type: object
      required:
        - token_type
        - access_token
        - refresh_token
      properties:
        token_type:
          type: string
        access_token:
          type: string
        refresh_token:
          type: string

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string

    MessageResponse:
      type: object
      required:
        - msg
      properties:
        msg:
          type: string

    TrackUploadSuccessResponse:
      type: object
      required:
        - trackId
      properties:
        trackId:
          type: integer

    TrackUploadRequest:
      type: object
      required:
        - name
        - albumId
        - artistId
        - file
      properties:
        name:
          type: string
        albumId:
          type: integer
        artistId:
          type: integer
        file:
          type: string
          format: binary

    TrackMetadata:
      type: object
      required:
        - trackId
        - name
        - artistId
        - trackFastPreset
        - trackStandardPreset
        - trackHighPreset
        - trackLosslessPreset
      properties:
        trackId:
          type: integer
        name:
          type: string
        artistId:
          type: integer
        coverUrl:
          type: string
        trackFastPreset:
          type: string
        trackStandardPreset:
          type: string
        trackHighPreset:
          type: string
        trackLosslessPreset:
          type: string

    ArtistCreateRequest:
      type: object
      required:
        - artistName
      properties:
        artistName:
          type: string
        artistImage:
          type: string
          format: binary

    ArtistCreateResponse:
      type: object
      required:
        - artistId
      properties:
        artistId:
          type: integer

    ArtistInfoResponse:
      type: object
      required:
        - artistId
        - artistName
        - artistAlbums
      properties:
        artistId:
          type: integer
        artistName:
          type: string
        artistCoverUrl:
          type: string
        artistAlbums:
          type: array
          items:
            type: integer

    ArtistDeleteResponse:
      type: object
      required:
        - artistId
      properties:
        artistId:
          type: integer

    ArtistImageResponse:
      type: object
      required:
        - artistId
      properties:
        artistId:
          type: integer

    PlaylistCreateRequest:
      type: object
      required:
        - ownerId
        - playlistName
      properties:
        ownerId:
          type: integer
        playlistName:
          type: string
        playlistCover:
          type: string
          format: binary

    PlaylistCreateResponse:
      type: object
      required:
        - playlistId
      properties:
        playlistId:
          type: integer

    PlaylistInfoResponse:
      type: object
      required:
        - playlistId
        - playlistName
        - tracks
      properties:
        playlistId:
          type: integer
        playlistName:
          type: string
        coverUrl:
          type: string
        tracks:
          type: array
          items:
            type: integer

    PlaylistDeleteResponse:
      type: object
      required:
        - playlistId
      properties:
        playlistId:
          type: integer

    PlaylistCoverResponse:
      type: object
      required:
        - playlistId
      properties:
        playlistId:
          type: integer

    AlbumCreateRequest:
      type: object
      required:
        - ownerId
        - albumName
      properties:
        ownerId:
          type: integer
        albumName:
          type: string
        albumCover:
          type: string
          format: binary

    AlbumCreateResponse:
      type: object
      required:
        - albumId
      properties:
        albumId:
          type: integer

    AlbumInfoResponse:
      type: object
      required:
        - albumId
        - albumName
        - tracks
      properties:
        albumId:
          type: integer
        albumName:
          type: string
        coverUrl:
          type: string
        tracks:
          type: array
          items:
            type: integer

    AlbumDeleteResponse:
      type: object
      required:
        - albumId
      properties:
        albumId:
          type: integer

    AlbumCoverResponse:
      type: object
      required:
        - albumId
      properties:
        albumId:
          type: integer

paths:
  /auth/login:
    post:
      summary: "login user into account"
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserAuth'
      responses:
        '200':
          description: User was logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Error on invalid user credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      summary: "register new user"
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserAuth'
      responses:
        '201':
          description: New user account was created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Error if user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /user/{userId}:
    get:
      summary: get user by id
      operationId: getUserById
      parameters:
        - in: path
          name: userId
          schema:
            type: integer
          required: true
          description: user id, represented as int
      responses:
        '200':
          description: User data fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserReturn'
        '401':
          description: Unauthorized access, if something goes wrong with tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User with this id not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: update user
      operationId: changeUser
      parameters:
        - in: path
          name: userId
          schema:
            type: integer
          required: true
          description: user id, represented as int
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: User was successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /user/{userId}/avatar:
    post:
      summary: upload new user's avatar to server
      operationId: uploadUserAvatar
      parameters:
        - in: path
          name: userId
          schema:
            type: integer
          required: true
      requestBody:
        required: true
        content:
          image/webp:
            schema:
              type: string
              format: binary
      responses:
        '201':
          description: avatar was successfully uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: wrong format of an image
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: unkown server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: delete current avatar
      operationId: deleteUserAvatar
      parameters:
        - in: path
          name: userId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: avatar was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: unkown server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /user/{userId}/change_password:
    patch:
      summary: change user's password
      operationId: changePassword
      parameters:
        - in: path
          name: userId
          schema:
            type: integer
          required: true
          description: user id, represented as int
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserChangePassword'
      responses:
        '200':
          description: User's password was successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Invalid old password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /track/upload:
    post:
      summary: uploads new track, make all transcoding stuff, stores it
      operationId: uploadTrack
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/TrackUploadRequest'
        encoding:
          file:
            contentType: audio/*
      responses:
        '200':
          description: Track uploaded and processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrackUploadSuccessResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '415':
          description: Unsupported media type, uploading file is not an audio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Can't successfully upload a track
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /track/{trackId}:
    delete:
      summary: delete track
      operationId: deleteTrack
      parameters:
        - in: path
          name: trackId
          schema:
            type: integer
          required: true
          description: track id, represented as int
      responses:
        '200':
          description: Track was successfully deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: No such Track
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: getting track metadata
      operationId: getTrackMeta
      parameters:
        - in: path
          name: trackId
          schema:
            type: integer
          required: true
          description: track id, represented as int
      responses:
        '200':
          description: track meta was successfully fetched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrackMetadata'
        '401':
          description: unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: no track found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /artist/create:
    post:
      summary: creates new artist
      operationId: createArtist
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtistCreateRequest'
      responses:
        '201':
          description: artist was created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtistCreateResponse'
        '401':
          description: unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /artist/{artistId}:
    get:
      summary: get info about artist
      operationId: getArtist
      parameters:
        - in: path
          name: artistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: artist info was successfully fetched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtistInfoResponse'
        '401':
          description: unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: no artist was found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: deletes artist by id
      operationId: deleteArtist
      parameters:
        - in: path
          name: artistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: artist was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtistDeleteResponse'
        '401':
          description: unauthorized
        '404':
          description: no artist was found
        '500':
          description: internal server error

  /artist/{artistId}/image:
    post:
      description: uploads a new image of an artist
      operationId: uploadArtistImage
      parameters:
        - in: path
          name: artistId
          schema:
            type: integer
          required: true
      requestBody:
        content:
          image/*:
            schema:
              type: string
              format: binary
      responses:
        '201':
          description: image of an artist was successfully uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtistImageResponse'
        '401':
          description: unauthorized
        '404':
          description: no artist was found
        '500':
          description: internal server error
    delete:
      description: deletes an image of an artist, if there's none no-op
      operationId: deleteArtistImage
      parameters:
        - in: path
          name: artistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: image of an artist was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtistImageResponse'
        '401':
          description: unauthorized
        '404':
          description: no artist was found
        '500':
          description: internal server error
    get:
      description: fetching image of an artist
      operationId: getArtistImage
      parameters:
        - in: path
          name: artistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: image of an artist was successfully fetched
          content:
            image/webp:
              schema:
                type: string
                format: binary
        '401':
          description: unauthorized
        '404':
          description: no artist was found
        '500':
          description: internal server error

  /playlist/create:
    post:
      summary: creates new playlist
      operationId: createPlaylist
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/PlaylistCreateRequest'
      responses:
        '201':
          description: playlist was created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistCreateResponse'
        '401':
          description: unauthorized
        '500':
          description: internal server error

  /playlist/{playlistId}:
    get:
      summary: get info about playlist
      operationId: getPlaylist
      parameters:
        - in: path
          name: playlistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: playlist data was successfully fetched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistInfoResponse'
        '401':
          description: unauthorized
        '404':
          description: no playlist found
        '500':
          description: internal server error
    delete:
      summary: deletes playlist by id
      operationId: deletePlaylist
      parameters:
        - in: path
          name: playlistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: playlist was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistDeleteResponse'
        '401':
          description: unauthorized
        '404':
          description: no playlist found
        '500':
          description: internal server error

  /playlist/{playlistId}/cover:
    post:
      description: uploads a new cover for the playlist
      operationId: uploadPlaylistCover
      parameters:
        - in: path
          name: playlistId
          schema:
            type: integer
          required: true
      requestBody:
        content:
          image/*:
            schema:
              type: string
              format: binary
      responses:
        '201':
          description: cover of the playlist was successfully uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistCoverResponse'
        '401':
          description: unauthorized
        '404':
          description: no playlist was found
        '500':
          description: internal server error
    delete:
      description: deletes the playlist's cover, if there's none no-op
      operationId: deletePlaylistCover
      parameters:
        - in: path
          name: playlistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: cover of the playlist was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistCoverResponse'
        '401':
          description: unauthorized
        '404':
          description: no playlist was found
        '500':
          description: internal server error
    get:
      description: fetching cover of the playlist
      operationId: getPlaylistCover
      parameters:
        - in: path
          name: playlistId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: cover of the playlist was successfully fetched
          content:
            image/webp:
              schema:
                type: string
                format: binary
        '401':
          description: unauthorized
        '404':
          description: no playlist was found
        '500':
          description: internal server error

  /album/create:
    post:
      summary: creates new album
      operationId: createAlbum
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/AlbumCreateRequest'
      responses:
        '201':
          description: album was created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlbumCreateResponse'
        '401':
          description: unauthorized
        '500':
          description: internal server error

  /album/{albumId}:
    get:
      summary: get info about the album
      operationId: getAlbum
      parameters:
        - in: path
          name: albumId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: album data was successfully fetched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlbumInfoResponse'
        '401':
          description: unauthorized
        '404':
          description: no album found
        '500':
          description: internal server error
    delete:
      summary: deletes album by id
      operationId: deleteAlbum
      parameters:
        - in: path
          name: albumId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: album was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlbumDeleteResponse'
        '401':
          description: unauthorized
        '404':
          description: no album found
        '500':
          description: internal server error

  /album/{albumId}/cover:
    post:
      description: uploads a new cover for the album
      operationId: uploadAlbumCover
      parameters:
        - in: path
          name: albumId
          schema:
            type: integer
          required: true
      requestBody:
        content:
          image/*:
            schema:
              type: string
              format: binary
      responses:
        '201':
          description: cover of the album was successfully uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlbumCoverResponse'
        '401':
          description: unauthorized
        '404':
          description: no album was found
        '500':
          description: internal server error
    delete:
      description: deletes the album's cover, if there's none no-op
      operationId: deleteAlbumCover
      parameters:
        - in: path
          name: albumId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: cover of the album was successfully deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlbumCoverResponse'
        '401':
          description: unauthorized
        '404':
          description: no album was found
        '500':
          description: internal server error
    get:
      description: fetching cover of the album
      operationId: getAlbumCover
      parameters:
        - in: path
          name: albumId
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: cover of the album was successfully fetched
          content:
            image/webp:
              schema:
                type: string
                format: binary
        '401':
          description: unauthorized
        '404':
          description: no album was found
        '500':
          description: internal server error
